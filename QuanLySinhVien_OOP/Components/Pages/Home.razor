@page "/"
@rendermode InteractiveServer
@using QuanLySinhVien_OOP.Models
@using QuanLySinhVien_OOP.Services
@inject IStudentService StudentService
@inject NavigationManager Navigation

<PageTitle>Quản lý Sinh viên</PageTitle>

<div class="container-fluid">
    <h2 class="mb-3">Quản lý Sinh viên</h2>

    <!-- Thanh công cụ: Tìm kiếm và Thêm mới -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" 
                   class="form-control" 
                   placeholder="Tìm kiếm theo mã SV hoặc họ tên..." 
                   @bind="searchKeyword"
                   @bind:event="oninput"
                   @onkeyup="OnSearchAsync" />
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" @onclick="NavigateToAdd">
                + Thêm Sinh viên
            </button>
        </div>
    </div>

    <!-- Thông báo -->
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible" role="alert">
            @message
            <button type="button" class="btn-close" @onclick="ClearMessage"></button>
        </div>
    }

    <!-- Bảng danh sách sinh viên -->
    @if (isLoading)
    {
        <p><em>Đang tải dữ liệu...</em></p>
    }
    else if (students == null || !students.Any())
    {
        <div class="alert alert-info">
            @if (string.IsNullOrEmpty(searchKeyword))
            {
                <span>Chưa có sinh viên nào. Hãy thêm sinh viên mới!</span>
            }
            else
            {
                <span>Không tìm thấy sinh viên phù hợp với "@searchKeyword"</span>
            }
        </div>
    }
    else
    {
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>Mã SV</th>
                    <th>Họ tên</th>
                    <th>Ngày sinh</th>
                    <th>Toán</th>
                    <th>Văn</th>
                    <th>Anh</th>
                    <th>ĐTB</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @{ var stt = 1; }
                @foreach (var sv in students)
                {
                    <tr>
                        <td>@(stt++)</td>
                        <td><strong>@sv.MaSV</strong></td>
                        <td>@sv.HoTen</td>
                        <td>@sv.NgaySinh.ToString("dd/MM/yyyy")</td>
                        <td>@sv.DiemToan.ToString("F1")</td>
                        <td>@sv.DiemVan.ToString("F1")</td>
                        <td>@sv.DiemAnh.ToString("F1")</td>
                        <td>
                            <span class="badge @GetDiemTBClass(sv.TinhDiemTB())">
                                @sv.TinhDiemTB().ToString("F2")
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" 
                                    @onclick="() => NavigateToEdit(sv.MaSV)">
                                Sửa
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    @onclick="() => ConfirmDelete(sv)">
                                Xóa
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        <p class="text-muted">Tổng số: <strong>@students.Count</strong> sinh viên</p>
    }

    <!-- Modal xác nhận xóa -->
    @if (showDeleteModal && studentToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Xác nhận xóa</h5>
                        <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                    </div>
                    <div class="modal-body">
                        <p>Bạn có chắc chắn muốn xóa sinh viên này?</p>
                        <ul>
                            <li><strong>Mã SV:</strong> @studentToDelete.MaSV</li>
                            <li><strong>Họ tên:</strong> @studentToDelete.HoTen</li>
                            <li><strong>ĐTB:</strong> @studentToDelete.TinhDiemTB().ToString("F2")</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">
                            Hủy
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="DeleteStudentAsync">
                            Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Student>? students;
    private string searchKeyword = string.Empty;
    private bool isLoading = true;
    private string message = string.Empty;
    private bool isError = false;
    private bool showDeleteModal = false;
    private Student? studentToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudentsAsync();
    }

    private async Task LoadStudentsAsync()
    {
        isLoading = true;
        try
        {
            students = await StudentService.GetAllStudentsAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Lỗi tải dữ liệu: {ex.Message}", true);
            students = new List<Student>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSearchAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(searchKeyword))
            {
                students = await StudentService.GetAllStudentsAsync();
            }
            else
            {
                students = await StudentService.SearchStudentAsync(searchKeyword);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Lỗi tìm kiếm: {ex.Message}", true);
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/student/add");
    }

    private void NavigateToEdit(string maSV)
    {
        Navigation.NavigateTo($"/student/edit/{maSV}");
    }

    private void ConfirmDelete(Student sv)
    {
        studentToDelete = sv;
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        studentToDelete = null;
        showDeleteModal = false;
    }

    private async Task DeleteStudentAsync()
    {
        if (studentToDelete == null) return;

        try
        {
            await StudentService.DeleteStudentAsync(studentToDelete.MaSV);
            ShowMessage($"Đã xóa sinh viên {studentToDelete.HoTen} thành công!", false);
            await LoadStudentsAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Lỗi xóa sinh viên: {ex.Message}", true);
        }
        finally
        {
            CancelDelete();
        }
    }

    private void ShowMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
    }

    private void ClearMessage()
    {
        message = string.Empty;
    }

    private string GetDiemTBClass(double diemTB)
    {
        return diemTB switch
        {
            >= 8.0 => "bg-success",
            >= 6.5 => "bg-primary", 
            >= 5.0 => "bg-warning text-dark",
            _ => "bg-danger"
        };
    }
}
