@page "/student/add"
@page "/student/edit/{MaSV}"
@rendermode InteractiveServer
@using QuanLySinhVien_OOP.Models
@using QuanLySinhVien_OOP.Services
@inject IStudentService StudentService
@inject NavigationManager Navigation

<PageTitle>@(IsEditMode ? "Sửa Sinh viên" : "Thêm Sinh viên")</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h3>@(IsEditMode ? "Sửa thông tin Sinh viên" : "Thêm Sinh viên mới")</h3>
            <hr />

            @if (isLoading)
            {
                <p><em>Đang tải...</em></p>
            }
            else if (student == null)
            {
                <div class="alert alert-danger">
                    Không tìm thấy sinh viên với mã "@MaSV"
                </div>
                <button class="btn btn-secondary" @onclick="NavigateBack">
                    Quay lại
                </button>
            }
            else
            {
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        @errorMessage
                    </div>
                }

                <EditForm Model="student" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    <!-- Mã sinh viên -->
                    <div class="mb-3">
                        <label for="maSV" class="form-label">Mã sinh viên *</label>
                        <InputText id="maSV" 
                                   class="form-control" 
                                   @bind-Value="student.MaSV" 
                                   placeholder="VD: SV001"
                                   disabled="@IsEditMode" />
                        <ValidationMessage For="@(() => student.MaSV)" class="text-danger" />
                    </div>

                    <!-- Họ tên -->
                    <div class="mb-3">
                        <label for="hoTen" class="form-label">Họ và tên *</label>
                        <InputText id="hoTen" 
                                   class="form-control" 
                                   @bind-Value="student.HoTen" 
                                   placeholder="Nhập họ và tên" />
                        <ValidationMessage For="@(() => student.HoTen)" class="text-danger" />
                    </div>

                    <!-- Ngày sinh -->
                    <div class="mb-3">
                        <label for="ngaySinh" class="form-label">Ngày sinh *</label>
                        <InputDate id="ngaySinh" 
                                   class="form-control" 
                                   @bind-Value="student.NgaySinh" />
                        <ValidationMessage For="@(() => student.NgaySinh)" class="text-danger" />
                    </div>

                    <!-- Điểm các môn -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="diemToan" class="form-label">Điểm Toán *</label>
                            <InputNumber id="diemToan" 
                                         class="form-control" 
                                         @bind-Value="student.DiemToan"
                                         min="0" max="10" step="0.1" />
                            <ValidationMessage For="@(() => student.DiemToan)" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="diemVan" class="form-label">Điểm Văn *</label>
                            <InputNumber id="diemVan" 
                                         class="form-control" 
                                         @bind-Value="student.DiemVan"
                                         min="0" max="10" step="0.1" />
                            <ValidationMessage For="@(() => student.DiemVan)" class="text-danger" />
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="diemAnh" class="form-label">Điểm Anh *</label>
                            <InputNumber id="diemAnh" 
                                         class="form-control" 
                                         @bind-Value="student.DiemAnh"
                                         min="0" max="10" step="0.1" />
                            <ValidationMessage For="@(() => student.DiemAnh)" class="text-danger" />
                        </div>
                    </div>

                    <!-- Điểm TB preview -->
                    <div class="mb-3 p-2 bg-light">
                        <strong>Điểm trung bình:</strong> @student.TinhDiemTB().ToString("F2")
                    </div>

                    <!-- Nút thao tác -->
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @(isSaving ? "Đang lưu..." : (IsEditMode ? "Cập nhật" : "Lưu"))
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="NavigateBack">
                            Quay lại
                        </button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? MaSV { get; set; }

    private Student? student;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = string.Empty;

    private bool IsEditMode => !string.IsNullOrEmpty(MaSV);

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            if (IsEditMode)
            {
                var existingStudent = await StudentService.GetStudentByIdAsync(MaSV!);
                if (existingStudent != null)
                {
                    student = new Student
                    {
                        MaSV = existingStudent.MaSV,
                        HoTen = existingStudent.HoTen,
                        NgaySinh = existingStudent.NgaySinh,
                        DiemToan = existingStudent.DiemToan,
                        DiemVan = existingStudent.DiemVan,
                        DiemAnh = existingStudent.DiemAnh
                    };
                }
                else
                {
                    student = null;
                }
            }
            else
            {
                student = new Student
                {
                    NgaySinh = DateTime.Now.AddYears(-18),
                    DiemToan = 0,
                    DiemVan = 0,
                    DiemAnh = 0
                };
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
            student = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (student == null) return;

        isSaving = true;
        errorMessage = string.Empty;

        try
        {
            if (IsEditMode)
            {
                await StudentService.UpdateStudentAsync(student);
            }
            else
            {
                if (await StudentService.IsMaSVExistsAsync(student.MaSV))
                {
                    errorMessage = $"Mã sinh viên '{student.MaSV}' đã tồn tại!";
                    isSaving = false;
                    return;
                }
                await StudentService.AddStudentAsync(student);
            }
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/");
    }
}
